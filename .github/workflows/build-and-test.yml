name: Build and Test

permissions:
  contents: read

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - "gh-pages/**"
      - "*.md"
  push:
    branches:
      - main
    paths-ignore:
      - "gh-pages/**"
      - "*.md"
  workflow_call:
    inputs:
      ref:
        description: "Ref to check out and build. Defaults to the triggering ref."
        required: false
        type: string

concurrency:
  group: ${{ github.event_name }}-${{ github.event.number || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  build-linux-x86_64:
    uses: ./.github/workflows/build-target.yml
    with:
      os: ubuntu-latest
      target: x86_64-unknown-linux-gnu
      ref: ${{ inputs.ref }}
    secrets: inherit

  build-linux-i686:
    uses: ./.github/workflows/build-target.yml
    with:
      os: ubuntu-latest
      target: i686-unknown-linux-gnu
      ref: ${{ inputs.ref }}
    secrets: inherit

  build-linux-aarch64:
    uses: ./.github/workflows/build-target.yml
    with:
      os: ubuntu-24.04-arm
      target: aarch64-unknown-linux-gnu
      ref: ${{ inputs.ref }}
    secrets: inherit

  build-windows-x86_64:
    uses: ./.github/workflows/build-target.yml
    with:
      os: windows-latest
      target: x86_64-pc-windows-msvc
      ref: ${{ inputs.ref }}
    secrets: inherit

  build-windows-i686:
    uses: ./.github/workflows/build-target.yml
    with:
      os: windows-latest
      target: i686-pc-windows-msvc
      ref: ${{ inputs.ref }}
    secrets: inherit

  build-windows-arm64:
    uses: ./.github/workflows/build-target.yml
    with:
      os: windows-11-arm
      target: aarch64-pc-windows-msvc
      ref: ${{ inputs.ref }}
    secrets: inherit

  build-macos-x86_64:
    uses: ./.github/workflows/build-target.yml
    with:
      os: macos-latest
      target: x86_64-apple-darwin
      ref: ${{ inputs.ref }}
    secrets: inherit

  build-macos-arm64:
    uses: ./.github/workflows/build-target.yml
    with:
      os: macos-latest
      target: aarch64-apple-darwin
      ref: ${{ inputs.ref }}
    secrets: inherit

  e2e-linux-x86_64:
    needs: build-linux-x86_64
    uses: ./.github/workflows/e2e-target.yml
    permissions:
      contents: read
      id-token: write
    with:
      os: ubuntu-latest
      target: x86_64-unknown-linux-gnu
    secrets: inherit

  e2e-linux-aarch64:
    needs: build-linux-aarch64
    uses: ./.github/workflows/e2e-target.yml
    permissions:
      contents: read
      id-token: write
    with:
      os: ubuntu-24.04-arm
      target: aarch64-unknown-linux-gnu
    secrets: inherit

  e2e-windows-x86_64:
    needs: build-windows-x86_64
    uses: ./.github/workflows/e2e-target.yml
    permissions:
      contents: read
      id-token: write
    with:
      os: windows-latest
      target: x86_64-pc-windows-msvc
    secrets: inherit

  e2e-windows-arm64:
    needs: build-windows-arm64
    uses: ./.github/workflows/e2e-target.yml
    permissions:
      contents: read
      id-token: write
    with:
      os: windows-11-arm
      target: aarch64-pc-windows-msvc
    secrets: inherit

  e2e-macos-x86_64:
    needs: build-macos-x86_64
    uses: ./.github/workflows/e2e-target.yml
    permissions:
      contents: read
      id-token: write
    with:
      os: macos-latest
      target: x86_64-apple-darwin
    secrets: inherit

  e2e-macos-arm64:
    needs: build-macos-arm64
    uses: ./.github/workflows/e2e-target.yml
    permissions:
      contents: read
      id-token: write
    with:
      os: macos-latest
      target: aarch64-apple-darwin
    secrets: inherit

  delete-artifacts:
    name: Delete Artifacts (standalone runs)
    if: always() && (github.event_name == 'push' || github.event_name == 'pull_request')
    needs:
      - e2e-linux-x86_64
      - e2e-linux-aarch64
      - e2e-windows-x86_64
      - e2e-windows-arm64
      - e2e-macos-x86_64
      - e2e-macos-arm64
    permissions:
      contents: read
      actions: write
    uses: ./.github/workflows/cleanup-artifacts.yml
